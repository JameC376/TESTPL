<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Auto HLS Player</title>

  <!-- Video.js CSS -->
  <link
    href="https://vjs.zencdn.net/7.20.3/video-js.css"
    rel="stylesheet"
  />

  <style>
    /* เต็มจอทั้งแนวตั้ง-แนวนอน */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ให้ Video.js วางตัวแบบ fluid */
    .video-js {
      width: 100%;
      max-width: 100%;
      height: auto;
    }

    /* โครงร่างสวยงามเล็กน้อย */
    .vjs-default-skin .vjs-control-bar {
      background: rgba(0, 0, 0, 0.6);
    }
  </style>
</head>
<body>

  <!-- Video.js element -->
  <video
    id="hls-player"
    class="video-js vjs-default-skin vjs-fluid"
    controls
    autoplay
    muted
    preload="auto"
  ></video>

  <!-- Video.js + HLS -->
  <script src="https://vjs.zencdn.net/7.20.3/video.min.js"></script>

  <script>
    (async function() {
      try {
        // ดึง HTML หน้าเป้าหมาย
        const raw = await fetch(
          'https://cors-anywhere.herokuapp.com/https://halu.serv00.net/poli.php'
        ).then(res => res.text());

        // แปลงเป็น DOM เพื่อค้นหา .m3u8
        const parser = new DOMParser();
        const doc = parser.parseFromString(raw, 'text/html');
        let src = '';

        // ลองหา <source> แบบ HLS หรือ <iframe>
        const videoSrc = doc.querySelector(
          'video source[type="application/x-mpegURL"]'
        );
        const iframeSrc = doc.querySelector('iframe');

        if (videoSrc) {
          src = videoSrc.src;
        } else if (iframeSrc) {
          src = iframeSrc.src;
        }

        if (!src) {
          throw new Error('ไม่พบลิงก์ .m3u8 ในหน้าเป้าหมาย');
        }

        // จัดการกรณีเป็น URL relative
        const streamUrl = src.startsWith('http')
          ? src
          : new URL(src, 'https://halu.serv00.net').href;

        // สร้าง Video.js player และตั้งค่า HLS
        const player = videojs('hls-player', {
          fluid: true,
          autoplay: true,
          controls: true,
          preload: 'auto',
          sources: [
            {
              src: streamUrl,
              type: 'application/x-mpegURL'
            }
          ]
        });

        // ใส่ event log (อ้างอิงเพิ่มเติมได้)
        player.on('error', () => {
          console.error('Video.js error:', player.error());
        });

      } catch (err) {
        console.error(err);
        document.body.innerHTML = 
          '<p style="color:#fff; text-align:center;">เกิดข้อผิดพลาด: ' +
          err.message +
          '</p>';
      }
    })();
  </script>
</body>
</html>
